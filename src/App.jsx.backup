import React, { useEffect } from 'react';
import {
  HashRouter as Router,
  Routes,
  Route,
  Link,
  Navigate,
  Outlet,
  useNavigate,
  useLocation
} from 'react-router-dom';
import { AuthProvider, useAuth } from './contexts/AuthProvider.jsx';

// Page Imports
import LandingPage from './pages/LandingPage.js';
import Login from './pages/Login.js';
import Signup from './pages/Signup.js';
import HomePage from './HomePage.jsx';
import Scanner from './pages/Scanner.jsx';
import Ingredients from './pages/Ingredients.jsx';
import About from './pages/About.jsx';
import Contact from './pages/Contact.jsx';
import Faq from './pages/Faq.jsx';
import Recipes from './pages/Recipes.jsx';
import Account from './pages/Account.jsx';
import History from './pages/History.jsx';
import Settings from './pages/Settings.jsx';

// Style Imports
import './css/main.css';

// Register custom web components
import './js/components/bs-auth.js';

/**
 * A layout component for the main application after a user is authenticated.
 * It includes the shared navigation header.
 */
function AppLayout() {
  const { logout, setLastPage, user, loading } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  // Additional security check - ensure user is authenticated before rendering
  useEffect(() => {
    if (!loading && !user) {
      console.error('Security breach: AppLayout rendered for unauthenticated user');
      navigate('/login', { replace: true });
    }
  }, [user, loading, navigate]);

  // Track current page for "continue where you left off" feature
  useEffect(() => {
    if (location.pathname.startsWith('/app/') && user) {
      setLastPage(location.pathname);
    }
  }, [location.pathname, setLastPage, user]);

  // Don't render anything if not authenticated
  if (loading || !user) {
    return (
      <div
        style={{
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          height: '100vh',
          background: 'linear-gradient(135deg, var(--food-green) 0%, var(--food-mint) 100%)',
          color: 'white'
        }}
      >
        <div style={{ fontSize: '2rem', marginBottom: '1rem' }}>ðŸ”’</div>
        <div style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>Verifying access...</div>
      </div>
    );
  }

  const handleLogout = async e => {
    e.preventDefault();
    e.stopPropagation();

    try {
      console.log('Logout button clicked');
      await logout();
      console.log('Logout successful, redirecting...');
      // After logout, redirect user to the landing page for security.
      // The ProtectedRoutes component will ensure they can't access protected routes
      navigate('/', { replace: true });
    } catch (error) {
      console.error('Logout error:', error);
      // Even if logout fails, try to redirect
      navigate('/', { replace: true });
    }
  };

  return (
    <div>
      <header className="navigation">
        <nav>
          <div className="nav-brand">
            <svg
              width="32"
              height="32"
              viewBox="0 0 32 32"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              style={{ marginRight: '0.5rem' }}
            >
              <rect width="32" height="32" rx="6" fill="var(--food-green)" />
              <path d="M16 8L20 14H12L16 8Z" fill="var(--food-mint)" />
              <path d="M8 20L12 26H4L8 20Z" fill="var(--food-mint)" />
              <path d="M24 20L28 26H20L24 20Z" fill="var(--food-mint)" />
            </svg>
            <span style={{ fontWeight: 700, color: 'white' }}>SNHU Scanner</span>
          </div>
          <div className="nav-links">
            <Link to="/app/home">Home</Link>
            <Link to="/app/scanner">Scanner</Link>
            <Link to="/app/ingredients">Ingredients</Link>
            <Link to="/app/recipes">Recipes</Link>
            <button
              type="button"
              onClick={handleLogout}
              className="logout-button"
              aria-label="Logout"
            >
              Logout
            </button>
          </div>
        </nav>
      </header>
      <main>
        {/* The nested route component will be rendered here */}
        <Outlet />
      </main>
    </div>
  );
}

/**
 * A component to guard routes that require authentication.
 * It checks the user's auth state and redirects to login if they are not authenticated.
 * Includes additional security checks to prevent unauthorized access.
 */
function ProtectedRoutes() {
  const { user, loading, getIdToken } = useAuth();

  // Additional security check - verify user has valid token
  useEffect(() => {
    const verifyAuth = async () => {
      if (user && !loading) {
        try {
          const token = await getIdToken();
          if (!token) {
            // Token is invalid, force logout
            console.warn('Invalid authentication token detected, redirecting to login');
            window.location.href = '/login';
          }
        } catch (error) {
          console.error('Error verifying authentication:', error);
          window.location.href = '/login';
        }
      }
    };

    verifyAuth();
  }, [user, loading, getIdToken]);

  if (loading) {
    // Show a loading indicator while checking auth state
    return (
      <div
        style={{
          display: 'flex',
          flexDirection: 'column',
          justifyContent: 'center',
          alignItems: 'center',
          height: '100vh',
          background: 'linear-gradient(135deg, var(--food-green) 0%, var(--food-mint) 100%)',
          color: 'white'
        }}
      >
        <div style={{ fontSize: '2rem', marginBottom: '1rem' }}>ðŸ”’</div>
        <div style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>Securing your session...</div>
        <div style={{ fontSize: '0.9rem', opacity: 0.8, marginTop: '0.5rem' }}>Please wait</div>
      </div>
    );
  }

  if (!user) {
    // If not logged in, redirect to the login page
    // This ensures users cannot access protected routes without authentication
    return <Navigate to="/login" replace />;
  }

  // If logged in, render the main app layout which contains the nested routes
  return <AppLayout />;
}

/**
 * Global security check component that monitors all route changes
 * and ensures protected routes are only accessible to authenticated users.
 */
function GlobalSecurityCheck() {
  const { user, loading } = useAuth();
  const location = useLocation();

  useEffect(() => {
    // Skip security checks during loading
    if (loading) return;

    const currentPath = location.pathname;

    // Define protected routes
    const protectedRoutes = [
      '/app/home',
      '/app/scanner',
      '/app/ingredients',
      '/app/recipes',
      '/app/account',
      '/app/history',
      '/app/settings'
    ];

    // Check if current route is protected
    const isProtectedRoute = protectedRoutes.some(route =>
      currentPath.startsWith(route) || currentPath === route
    );

    // If trying to access protected route without authentication
    if (isProtectedRoute && !user) {
      console.error(`Security breach: Attempted access to protected route ${currentPath} without authentication`);
      // Force redirect to login
      window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
      return;
    }

    // If authenticated user tries to access public auth pages, redirect to app
    const publicAuthRoutes = ['/login', '/signup'];
    if (user && publicAuthRoutes.includes(currentPath)) {
      console.log('Authenticated user accessing auth page, redirecting to app');
      window.location.href = '/app/home';
      return;
    }

  }, [location.pathname, user, loading]);

  // This component doesn't render anything
  return null;
}

export default function App() {
  return (
    <AuthProvider>
      <Router future={{ v7_startTransition: true, v7_relativeSplatPath: true }}>
        <GlobalSecurityCheck />
        <Routes>

  useEffect(() => {
    // Check for expired session even if Firebase has a user
    const checkExpiredSession = async () => {
      const SESSION_TIMESTAMP_KEY = 'barcode-scanner/sessionTimestamp';
      const LAST_ACTIVITY_KEY = 'barcode-scanner/lastActivity';
      const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes

      const lastActivity = localStorage.getItem(LAST_ACTIVITY_KEY);
      const sessionTimestamp = localStorage.getItem(SESSION_TIMESTAMP_KEY);

      // If timestamps exist, check if session expired
      if (lastActivity && sessionTimestamp) {
        const lastActivityTime = parseInt(lastActivity, 10);
        const timeSinceLastActivity = Date.now() - lastActivityTime;

        // If more than 10 minutes of inactivity, clear session
        if (timeSinceLastActivity > INACTIVITY_TIMEOUT) {
          console.log('Session expired on public route. Clearing session...');
          localStorage.removeItem(SESSION_TIMESTAMP_KEY);
          localStorage.removeItem(LAST_ACTIVITY_KEY);
          localStorage.removeItem('user');
          // If user exists, logout will be handled by auth state change
        }
      } else if (user) {
        // If user exists but no session timestamps, clear them (session invalid)
        localStorage.removeItem(SESSION_TIMESTAMP_KEY);
        localStorage.removeItem(LAST_ACTIVITY_KEY);
        localStorage.removeItem('user');
        try {
          await logout();
        } catch (error) {
          console.error('Error clearing expired session:', error);
        }
      }
    };

    if (!loading) {
      checkExpiredSession();
    }
  }, [user, loading, logout]);

  if (loading) {
    return (
      <div
        style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}
      >
        Loading...
      </div>
    );
  }

  // Check session expiry before redirecting
  const SESSION_TIMESTAMP_KEY = 'barcode-scanner/sessionTimestamp';
  const LAST_ACTIVITY_KEY = 'barcode-scanner/lastActivity';
  const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes

  const lastActivity = localStorage.getItem(LAST_ACTIVITY_KEY);
  const sessionTimestamp = localStorage.getItem(SESSION_TIMESTAMP_KEY);

  // If user exists but session has expired, don't redirect (let them see landing page)
  if (user && lastActivity && sessionTimestamp) {
    const lastActivityTime = parseInt(lastActivity, 10);
    const timeSinceLastActivity = Date.now() - lastActivityTime;
    
    // If session is still valid, redirect to home
    if (timeSinceLastActivity <= INACTIVITY_TIMEOUT) {
      return <Navigate to="/app/home" replace />;
    }
    // Otherwise, session expired - allow access to public routes
  } else if (user && (!lastActivity || !sessionTimestamp)) {
    // User exists but no valid session timestamps - treat as logged out
    return children;
  }

  // If user is logged in with valid session, redirect to home
  if (user) {
    return <Navigate to="/app/home" replace />;
  }

  return children;
}

export default function App() {
  return (
    <AuthProvider>
      <Router future={{ v7_startTransition: true, v7_relativeSplatPath: true }}>
        <GlobalSecurityCheck />
        <Routes>
          {/* Public Routes - Redirect to home if already logged in */}
          <Route
            path="/"
            element={
              <PublicRoute>
                <LandingPage />
              </PublicRoute>
            }
          />
          <Route
            path="/login"
            element={
              <PublicRoute>
                <Login />
              </PublicRoute>
            }
          />
          <Route
            path="/signup"
            element={
              <PublicRoute>
                <Signup />
              </PublicRoute>
            }
          />
          {/* Public routes that don't require login check */}
          <Route path="/about" element={<About />} />
          <Route path="/contact" element={<Contact />} />
          <Route path="/faq" element={<Faq />} />

          {/* Protected Routes */}
          <Route element={<ProtectedRoutes />}>
            <Route path="/app/home" element={
              <SecurityWrapper>
                <HomePage />
              </SecurityWrapper>
            } />
            <Route path="/app/scanner" element={
              <SecurityWrapper>
                <Scanner />
              </SecurityWrapper>
            } />
            <Route path="/app/ingredients" element={
              <SecurityWrapper>
                <Ingredients />
              </SecurityWrapper>
            } />
            <Route path="/app/recipes" element={
              <SecurityWrapper>
                <Recipes />
              </SecurityWrapper>
            } />
            <Route path="/app/account" element={
              <SecurityWrapper>
                <Account />
              </SecurityWrapper>
            } />
            <Route path="/app/history" element={
              <SecurityWrapper>
                <History />
              </SecurityWrapper>
            } />
            <Route path="/app/settings" element={
              <SecurityWrapper>
                <Settings />
              </SecurityWrapper>
            } />
          </Route>

          {/* Fallback: Redirect any unknown paths to the landing page */}
          <Route path="*" element={<Navigate to="/" replace />} />
        </Routes>
      </Router>
    </AuthProvider>
  );
}
